import{reactive as e,toRefs as t,ref as o,watch as n,onMounted as r,onBeforeUnmount as l,resolveDirective as a,withDirectives as s,openBlock as u,createBlock as i,createVNode as c,vModelRadio as p,createTextVNode as d,toDisplayString as f,createCommentVNode as m,vModelText as h,vShow as S,Fragment as y,renderList as v,vModelSelect as w,vModelCheckbox as g}from"vue";function b(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function R(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function x(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function N(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?x(Object(o),!0).forEach((function(t){R(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):x(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}var C=e({isViewer:!1,changeLayers:0,changeGeometrys:0});var L,k,M={errorMsg:function(e){console.log("error",e),alert("error："+e)},warnMsg:function(e){console.log("warn",e)},successMsg:function(e){console.log("success",e)}},P=function(e){for(var t=[].concat(e),o=[],n=0,r=t.length;n<r;n++){var l=SuperMap3D.Cartographic.fromCartesian(t[n]),a=SuperMap3D.Math.toDegrees(l.longitude),s=SuperMap3D.Math.toDegrees(l.latitude),u=l.height;-1==o.indexOf(a)&&-1==o.indexOf(s)&&(o.push(a),o.push(s),o.push(u))}return o},I={showRenderLoopErrors:"渲染时发生错误，已停止渲染。",AttributeError:"该组件props没有这个属性：",NoPickPositionSupported:"不支持深度纹理,无法绘制多边形，地形操作功能无法使用！",NoTerrain:"请在地形里使用地形组件！",initViewerWarn:"请先初始化viewer!",MoveMouseHeightBox:"点击鼠标左键结束矩形绘制，移动鼠标绘制box高度",RightClickEndDrawing:"右键单击结束绘制",LeftClickBottomBox:"点击鼠标左键，开始绘制矩形作为box底面",ClickModelAddBox:"点击模型，添加裁剪盒子",SkyLineWarn:"获取天际线体前，请先绘制天际线！",SkyLineBody:"天际线体",ShadowqueryWarn:"此操作需要先开启阴影！",VeiwshedBody:"可视体",VeiwshedBodyHidden:"不可视体",EchartsErr:"二维显示需要echarts支持，未找到相关依赖！",BaseMapImg:"底图",tip1:"<p>点击左键确定操作区域中间点</p><p>右键单击结束绘制</p>"},V=(k=(navigator.language||navigator.browserLanguage).toLowerCase(),window.lang=k,k).toLowerCase();var A=((L=void 0!==V?V:(navigator.language||navigator.browserLanguage).toLowerCase()).startsWith("zh")||L.startsWith("ja"),I),E=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,o,n;return t=e,(o=[{key:"createXMLflyLine",value:function(e){var t=new DOMParser;window.parser=t;var o=t.parseFromString("<cusxmlRoute></cusxmlRoute>","text/xml");window.xmlDoc=o;var n=this.createSceneRouteNode(o),r=this.createRouteNode(o,e),l=this.createRouteStyleNode(o);r.appendChild(l);var a=e.routeStops;if(!(a.length<2)){for(var s=0;s<a.length;s++){var u=a[s],i={longitude:u.point[0],latitude:u.point[1],altitude:u.point[2],heading:u.heading*(180/Math.PI),tilt:u.tilt*(180/Math.PI)+90},c=this.createStopNode(o,i,u,s);r.appendChild(c)}return n.appendChild(r),o.children[0].appendChild(n),o.children[0].innerHTML}console.warn("节点数小于2")}},{key:"createSceneRouteNode",value:function(e){var t=e.createElement("SceneRoute");return t.setAttribute("xmlns","http://www.supermap.com.cn/ugc60"),t}},{key:"createRouteNode",value:function(e,t){var o=e.createElement("route"),n={name:t.routeName||"飞行路线",speed:t.speed||"200",lineType:"0",showroutestop:"False",showrouteline:"False",altitudefree:"False",headingfree:"False",tiltfree:"False",flycircle:"False",alongline:t.isAlongLine||"False"};for(var r in n)o.setAttribute(r,n[r]);return o}},{key:"createRouteStyleNode",value:function(e){var t=e.createElement("style"),o=e.createElement("geostyle3d"),n=e.createElement("linecolor");n.textContent="RGBA(147,112,219,255)";var r=e.createElement("linewidth");r.textContent=2;var l=e.createElement("altitudeMode");l.textContent="Absolute";var a=e.createElement("bottomAltitude");return a.textContent=0,o.appendChild(n),o.appendChild(r),o.appendChild(l),o.appendChild(a),t.appendChild(o),t}},{key:"createStopNode",value:function(e,t,o,n){var r=e.createElement("routestop"),l={name:o.stopName||"Stop"+(n+1),speed:o.speed,excluded:"False",viewType:"camera"};for(var a in l)r.setAttribute(a,l[a]);var s=this.createStopCameraNode(e,t);r.appendChild(s);var u=this.createStopStyleNode(e);r.appendChild(u);var i=this.createStopSettingNode(e,o);return r.appendChild(i),r}},{key:"createStopCameraNode",value:function(e,t){var o=e.createElement("camera");for(var n in t){var r=e.createElement(n);r.textContent=t[n],o.appendChild(r)}return o}},{key:"createStopStyleNode",value:function(e){var t={icon:"",markersize:4.8,markericonscale:1,markercolor:"RGBA(255, 255, 255, 255)"},o=e.createElement("style"),n=e.createElement("geostyle3d");for(var r in t){var l=e.createElement(r);l.textContent=t[r],n.appendChild(l)}return o.appendChild(n),o}},{key:"createStopSettingNode",value:function(e,t){var o=e.createElement("setting"),n={turnTime:t.surroundDuration||1.5,turnSlowly:"False",stopPlayMode:t.stopPlayMode||"StopPause",autoPlay:"False",pauseTime:t.waitTime||0,angularSpeed:1};for(var r in n){var l=e.createElement(r);l.textContent=n[r],o.appendChild(l)}return o}}])&&b(t.prototype,o),n&&b(t,n),e}();function T(e){var t=function(e){var t=document.createElement("DIV");t.className="tooltip",this._div=t,this.message="",e.appendChild(t)};return t.prototype.setVisible=function(e){this._div.style.right=e?"10px":"-300px"},t.prototype.showAt=function(e,t){t&&(this._div.style.top=t),e&&(this.setVisible(!0),this._div.innerHTML=e)},new t(e)}function F(a){var s,u,i=e({routeType:"designatedRoute",fileSrc:"",fpfUrl:null,selectedStopIndex:0,showRoute:!1,showStop:!1,currentStopNames:[],customRouteNames:[],customRouteSelectedIndex:null,routeStops:[],selectedAddedStopIndex:null,setStopName:"Stop-1",setStopSpeed:0,stopPlayMode:"StopPause",waitTime:0,surroundDuration:1,isAlongline:!1,routeSpeed:200});if(a)for(var c in a)i.hasOwnProperty(c)?i[c]=a[c]:M.errorMsg(A.AttributeError+c);var p,d,f=o(null),m=new FileReader,h=[];function S(){u=new SuperMap3D.RouteCollection(viewer.entities),s=new SuperMap3D.FlyManager({scene:viewer.scene,routes:u}),d=new E,i.fpfUrl&&y()}function y(){s.stop(),u.fromFile(i.fpfUrl),s.readyPromise.then((function(){var e=s.currentRoute;e.isLineVisible=i.showRoute,e.isStopVisible=i.showStop,w()}))}function v(){u.readyPromise.then((function(){s.routes=u;var e=s.currentRoute;e.isLineVisible=i.showRoute,e.isStopVisible=i.showStop,w()}))}function w(){i.currentStopNames.length=0;for(var e=0,t=(p=s.getAllRouteStops()).length;e<t;e++){var o=p[e].stopName||"Stop"+(e+1);i.currentStopNames.push(o)}}function g(){if(s.stop(),!(h.length<1))if(h.splice(i.customRouteSelectedIndex,1),i.customRouteNames.splice(i.customRouteSelectedIndex,1),h.length>0)i.customRouteSelectedIndex=0;else{i.customRouteSelectedIndex=null,i.currentStopNames.length=0;var e=s.currentRoute;e&&e.clear()}}return C.isViewer&&(window.tooltip||(window.tooltip=T(viewer._element)),S()),n((function(){return C.isViewer}),(function(e){e&&(window.tooltip||(window.tooltip=T(viewer._element)),S())})),r((function(){f.value.addEventListener("change",(function(e){s.stop();var t=s.currentRoute;t&&t.clear(),u=new SuperMap3D.RouteCollection(viewer.entities);var o=e.target.files[0];o&&(i.fileSrc=f.value.value,m.onload=function(e){var t=e.target.result;u.fromXML(t)},m.readAsBinaryString(o),v())}))})),n((function(){return i.selectedStopIndex}),(function(e){s&&s.stop();var t=Number(e),o=p[t];s.viewToStop(o)})),n((function(){return i.showRoute}),(function(e){var t=s.currentRoute;t&&(t.isLineVisible=e)})),n((function(){return i.showStop}),(function(e){var t=s.currentRoute;t&&(t.isStopVisible=e)})),n((function(){return i.fpfUrl}),(function(e){y()})),n((function(){return i.customRouteSelectedIndex}),(function(e){if(null!==e){s&&s.stop();var t=s.currentRoute;t&&t.clear(),(u=new SuperMap3D.RouteCollection(viewer.entities)).fromXML(h[e]),v()}})),n((function(){return i.selectedAddedStopIndex}),(function(e){var t=i.routeStops[e];t&&viewer.camera.setView({destination:SuperMap3D.Cartesian3.fromDegrees(t.point[0],t.point[1],t.point[2]),orientation:{heading:t.heading,pitch:t.tilt,roll:0}})})),n((function(){return i.routeType}),(function(e){"customRoute"===e?(window.tooltip.showAt(" <p>调整当前相机位置和视角</p><p>以当前相机位置和视角设置站点</p><p>点击添加保存此站点</p>","80%"),setTimeout((function(){window.tooltip.setVisible(!1)}),5e3)):window.tooltip.setVisible(!1);var t=s.currentRoute;t&&(t.isLineVisible=!1,t.isStopVisible=!1)})),l((function(){i=null,s=u=null,p=null,d=h=null})),N(N({},t(i)),{},{flyFile_dom:f,chooseFile:function(){f.value.click()},flyStart:function(){s.readyPromise.then((function(){s.play()}))},flyPause:function(){s&&s.pause()},flyStop:function(){s&&s.stop()},addStop:function(){s.stop();var e=viewer.camera.position,t=P(e),o={stopName:i.setStopName,point:t,heading:viewer.camera.heading,tilt:viewer.camera.pitch,speed:i.setStopSpeed,stopPlayMode:i.stopPlayMode,surroundDuration:i.surroundDuration,waitTime:i.waitTime};if(i.routeStops.push(o),i.routeStops.length>0){var n=i.routeStops.length,r=i.routeStops[n-1].stopName.split("-")[1]||1,l="Stop-"+(Number(r)+1);i.setStopName=l}i.selectedAddedStopIndex=i.routeStops.length-1},saveStop:function(){if(i.routeStops.length<2)M.warnMsg("节点小于2");else{h.length>0&&g();var e={routeName:"飞行路线_"+(h.length+1),speed:i.routeSpeed,isAlongLine:"False",routeStops:i.routeStops},t=d.createXMLflyLine(e);h.push(t),i.customRouteNames.push(e.routeName),null===i.customRouteSelectedIndex&&(i.customRouteSelectedIndex=0)}},restStops:function(){i.routeStops.length=0,i.setStopName="Stop-1",i.setStopSpeed=0,i.stopPlayMode="StopPause",i.waitTime=0,i.surroundDuration=1},downLoad:function(){var e=h[i.customRouteSelectedIndex];if(e){var t=new Blob([e]),o=document.createElement("a");o.download="fly-route.fpf",o.href=URL.createObjectURL(t),o.click()}},clearRoute:g,clearStop:function(){i.routeStops.splice(i.selectedAddedStopIndex,1),i.routeStops.length>0?i.selectedAddedStopIndex=i.routeStops.length-1:(i.selectedAddedStopIndex=null,i.setStopName="Stop-1")}})}var D={name:"Sm3dFlyRoute",props:{fpfUrl:{type:String},showRoute:{type:Boolean},showStop:{type:Boolean},stopPlayMode:{type:String},waitTime:{type:Number},surroundDuration:{type:Number},isAlongline:{type:Boolean},routeSpeed:{type:Number}},setup:function(e){var t=F(e);return{routeType:t.routeType,fileSrc:t.fileSrc,fpfUrl:t.fpfUrl,selectedStopIndex:t.selectedStopIndex,showRoute:t.showRoute,showStop:t.showStop,flyFile_dom:t.flyFile_dom,chooseFile:t.chooseFile,currentStopNames:t.currentStopNames,flyStart:t.flyStart,flyPause:t.flyPause,flyStop:t.flyStop,routeStops:t.routeStops,selectedAddedStopIndex:t.selectedAddedStopIndex,routeSpeed:t.routeSpeed,clearStop:t.clearStop,addStop:t.addStop,saveStop:t.saveStop,restStops:t.restStops,customRouteNames:t.customRouteNames,customRouteSelectedIndex:t.customRouteSelectedIndex,downLoad:t.downLoad,clearRoute:t.clearRoute}}},O={id:"fly-route-panel",class:"sm-panel"},U={class:"sm-function-module-sub-section",style:{margin:"0"}},j={class:"sm-half-L"},B={style:{width:"auto"}},_={style:{width:"auto"}},z={class:"sm-half-L"},W={class:"sm-half-L"},H={style:{width:"35%"}},X={type:"file",accept:".fpf",id:"flyFile",style:{display:"none"},ref:"flyFile_dom"},G={class:"sm-half-L"},q={style:{width:"35%"}},J={class:"sm-half-L flex-between"},K={style:{width:"auto"}},Q={style:{width:"auto"}},Y={class:"sm-half-L flex-around"},Z={class:"sm-half-L"},$={class:"sm-half-L"},ee={style:{width:"35%"}},te={class:"sm-half-L"},oe={style:{width:"35%"}},ne={class:"boxchild"},re={class:"sm-half-L"},le={style:{margin:"15px 0 5px 0"}},ae=c("div",{class:"sm-point"},null,-1),se={class:"sm-half-L"},ue={style:{width:"35%"}},ie={class:"sm-half-L"},ce={style:{width:"35%"}},pe={class:"sm-half-L flex-between"},de={style:{width:"auto"}},fe={style:{width:"auto"}},me={class:"sm-half-L flex-around"},he={class:"boxchild",style:{"margin-bottom":"-5px"}};D.render=function(e,t,o,n,r,l){var b=a("stopdrag"),R=a("drag");return s((u(),i("div",O,[s(c("div",U,[c("div",j,[c("label",B,[s(c("input",{type:"radio",value:"designatedRoute","onUpdate:modelValue":t[1]||(t[1]=function(e){return n.routeType=e})},null,512),[[p,n.routeType]]),d(" "+f(e.Resource.designatedRoute),1)]),c("label",_,[s(c("input",{type:"radio",value:"customRoute","onUpdate:modelValue":t[2]||(t[2]=function(e){return n.routeType=e})},null,512),[[p,n.routeType]]),d(" "+f(e.Resource.customRoute),1)])]),m(" 指定路线面板 "),s(c("div",z,[s(c("div",W,[c("label",H,f(e.Resource.routeType),1),s(c("input",{type:"text",class:"sm-input",disabled:"",style:{width:"63%",position:"relative","padding-right":"30px"},"onUpdate:modelValue":t[3]||(t[3]=function(e){return n.fileSrc=e}),placeholder:"选择飞行线路文件"},null,512),[[h,n.fileSrc]]),c("span",{class:"iconfont iconwenjianjia fpfFile",onClick:t[4]||(t[4]=function(){return n.chooseFile&&n.chooseFile.apply(n,arguments)})}),c("input",X,null,512)],512),[[S,!n.fpfUrl]]),s(c("div",G,[c("label",q,f(e.Resource.selectStop),1),s(c("select",{class:"sm-select",style:{width:"63%"},"onUpdate:modelValue":t[5]||(t[5]=function(e){return n.selectedStopIndex=e})},[(u(!0),i(y,null,v(n.currentStopNames,(function(e,t){return u(),i("option",{value:t,key:t},f(e),9,["value"])})),128))],512),[[w,n.selectedStopIndex]])],512),[[S,n.currentStopNames.length>0]]),c("div",J,[c("label",K,[s(c("input",{type:"checkbox","onUpdate:modelValue":t[6]||(t[6]=function(e){return n.showRoute=e})},null,512),[[g,n.showRoute]]),d(" "+f(e.Resource.showRoute),1)]),c("label",Q,[s(c("input",{type:"checkbox","onUpdate:modelValue":t[7]||(t[7]=function(e){return n.showStop=e})},null,512),[[g,n.showStop]]),d(" "+f(e.Resource.showStop),1)])]),c("div",Y,[c("div",null,[c("span",{class:"iconfont iconbofang",style:{"font-size":"32px",color:"var(--theme-bg-color)"},onClick:t[8]||(t[8]=function(){return n.flyStart&&n.flyStart.apply(n,arguments)}),title:e.Resource.start},null,8,["title"])]),c("div",null,[c("span",{class:"iconfont iconzanting",style:{"font-size":"32px",color:"var(--theme-bg-color)"},onClick:t[9]||(t[9]=function(){return n.flyPause&&n.flyPause.apply(n,arguments)}),title:e.Resource.pause},null,8,["title"])]),c("div",null,[c("span",{class:"iconfont icontingzhi",style:{"font-size":"32px",color:"var(--theme-bg-color)"},onClick:t[10]||(t[10]=function(){return n.flyStop&&n.flyStop.apply(n,arguments)}),title:e.Resource.stop},null,8,["title"])])])],512),[[S,"designatedRoute"===n.routeType]]),m(" 自定义路线面板 "),s(c("div",Z,[s(c("div",null,[c("div",$,[c("label",ee,f(e.Resource.flySpeed),1),s(c("input",{type:"number",class:"sm-input",style:{width:"63%"},"onUpdate:modelValue":t[11]||(t[11]=function(e){return n.routeSpeed=e})},null,512),[[h,n.routeSpeed]])]),s(c("div",te,[c("label",oe,f(e.Resource.addedStops),1),s(c("select",{class:"sm-select",style:{width:"63%"},"onUpdate:modelValue":t[12]||(t[12]=function(e){return n.selectedAddedStopIndex=e})},[(u(!0),i(y,null,v(n.routeStops,(function(e,t){return u(),i("option",{value:t,key:t},f(e.stopName),9,["value"])})),128))],512),[[w,n.selectedAddedStopIndex]])],512),[[S,n.routeStops.length>0]]),c("div",ne,[c("button",{onClick:t[13]||(t[13]=function(){return n.addStop&&n.addStop.apply(n,arguments)}),class:"tbtn",type:"button"},f(e.Resource.add),1),c("button",{onClick:t[14]||(t[14]=function(){return n.clearStop&&n.clearStop.apply(n,arguments)}),class:"tbtn tbtn-margin-left",type:"button"},f(e.Resource.delete),1),c("button",{onClick:t[15]||(t[15]=function(){return n.restStops&&n.restStops.apply(n,arguments)}),class:"tbtn tbtn-margin-left",type:"button"},f(e.Resource.reset),1),c("button",{onClick:t[16]||(t[16]=function(){return n.saveStop&&n.saveStop.apply(n,arguments)}),class:"tbtn tbtn-margin-left",type:"button"},f(e.Resource.save),1)])],512),[[S,0==n.customRouteNames.length]]),m(' 保存飞行路线操作  v-show="customRouteNames.length>0" '),s(c("div",re,[c("div",le,[ae,d(" "+f(e.Resource.customRouteOperating),1)]),c("div",se,[c("label",ue,f(e.Resource.routeType),1),s(c("select",{class:"sm-select",style:{width:"63%"},"onUpdate:modelValue":t[17]||(t[17]=function(e){return n.customRouteSelectedIndex=e})},[(u(!0),i(y,null,v(n.customRouteNames,(function(e,t){return u(),i("option",{value:t,key:t},f(e),9,["value"])})),128))],512),[[w,n.customRouteSelectedIndex]])]),s(c("div",ie,[c("label",ce,f(e.Resource.selectStop),1),s(c("select",{class:"sm-select",style:{width:"63%"},"onUpdate:modelValue":t[18]||(t[18]=function(e){return n.selectedStopIndex=e})},[(u(!0),i(y,null,v(n.currentStopNames,(function(e,t){return u(),i("option",{value:t,key:t},f(e),9,["value"])})),128))],512),[[w,n.selectedStopIndex]])],512),[[S,n.currentStopNames.length>0]]),c("div",pe,[c("label",de,[s(c("input",{type:"checkbox","onUpdate:modelValue":t[19]||(t[19]=function(e){return n.showRoute=e})},null,512),[[g,n.showRoute]]),d(" "+f(e.Resource.showRoute),1)]),c("label",fe,[s(c("input",{type:"checkbox","onUpdate:modelValue":t[20]||(t[20]=function(e){return n.showStop=e})},null,512),[[g,n.showStop]]),d(" "+f(e.Resource.showStop),1)])]),c("div",me,[c("div",null,[c("span",{class:"iconfont iconbofang",style:{"font-size":"32px",color:"var(--theme-bg-color)"},onClick:t[21]||(t[21]=function(){return n.flyStart&&n.flyStart.apply(n,arguments)}),title:e.Resource.start},null,8,["title"])]),c("div",null,[c("span",{class:"iconfont iconzanting",style:{"font-size":"32px",color:"var(--theme-bg-color)"},onClick:t[22]||(t[22]=function(){return n.flyPause&&n.flyPause.apply(n,arguments)}),title:e.Resource.pause},null,8,["title"])]),c("div",null,[c("span",{class:"iconfont icontingzhi",style:{"font-size":"32px",color:"var(--theme-bg-color)"},onClick:t[23]||(t[23]=function(){return n.flyStop&&n.flyStop.apply(n,arguments)}),title:e.Resource.stop},null,8,["title"])]),c("div",he,[c("button",{onClick:t[24]||(t[24]=function(){return n.downLoad&&n.downLoad.apply(n,arguments)}),class:"tbtn",type:"button"},f(e.Resource.downLoad),1),c("button",{onClick:t[25]||(t[25]=function(){return n.clearRoute&&n.clearRoute.apply(n,arguments)}),class:"tbtn tbtn-margin-left",type:"button"},f(e.Resource.clear),1)])])],512),[[S,n.customRouteNames.length>0]])],512),[[S,"customRoute"===n.routeType]])],512),[[b]])],512)),[[R]])},D.__file="src/components/fly/fly-route/fly-route.vue",D.install=function(e){e.component(D.name,D)};export default D;
