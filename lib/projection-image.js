import{reactive as e,toRefs as t,ref as i,watch as n,onMounted as o,onBeforeUnmount as r,resolveComponent as a,resolveDirective as l,withDirectives as s,openBlock as c,createBlock as u,createVNode as d,toDisplayString as p,vModelText as v,vModelRadio as w,createTextVNode as f,vModelCheckbox as m,createCommentVNode as h}from"vue";function y(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function g(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function b(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?g(Object(i),!0).forEach((function(t){y(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):g(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function M(e){return function(e){if(Array.isArray(e))return P(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return P(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return P(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function P(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}var C=e({isViewer:!1,changeLayers:0,changeGeometrys:0}),S=function(e){for(var t=[].concat(e),i=[],n=0,o=t.length;n<o;n++){var r=SuperMap3D.Cartographic.fromCartesian(t[n]),a=SuperMap3D.Math.toDegrees(r.longitude),l=SuperMap3D.Math.toDegrees(r.latitude),s=r.height;-1==i.indexOf(a)&&-1==i.indexOf(l)&&(i.push(a),i.push(l),i.push(s))}return i};var D,L,x={errorMsg:function(e){console.log("error",e),alert("error："+e)},warnMsg:function(e){console.log("warn",e)},successMsg:function(e){console.log("success",e)}},j=S,E={showRenderLoopErrors:"渲染时发生错误，已停止渲染。",AttributeError:"该组件props没有这个属性：",NoPickPositionSupported:"不支持深度纹理,无法绘制多边形，地形操作功能无法使用！",NoTerrain:"请在地形里使用地形组件！",initViewerWarn:"请先初始化viewer!",MoveMouseHeightBox:"点击鼠标左键结束矩形绘制，移动鼠标绘制box高度",RightClickEndDrawing:"右键单击结束绘制",LeftClickBottomBox:"点击鼠标左键，开始绘制矩形作为box底面",ClickModelAddBox:"点击模型，添加裁剪盒子",SkyLineWarn:"获取天际线体前，请先绘制天际线！",SkyLineBody:"天际线体",ShadowqueryWarn:"此操作需要先开启阴影！",VeiwshedBody:"可视体",VeiwshedBodyHidden:"不可视体",EchartsErr:"二维显示需要echarts支持，未找到相关依赖！",BaseMapImg:"底图",tip1:"<p>点击左键确定操作区域中间点</p><p>右键单击结束绘制</p>"},I=(L=(navigator.language||navigator.browserLanguage).toLowerCase(),window.lang=L,L).toLowerCase();var O=((D=void 0!==I?I:(navigator.language||navigator.browserLanguage).toLowerCase()).startsWith("zh")||D.startsWith("ja"),E);var V=function(e,t){var i=0;switch(t&&(i=t),e){case"Point":window.handlerPoint=new SuperMap3D.DrawHandler(viewer,SuperMap3D.DrawMode.Point);break;case"Polyline":window.handlerPolyline=new SuperMap3D.DrawHandler(viewer,SuperMap3D.DrawMode.Line,i);break;case"Polygon":window.handlerPolygon=new SuperMap3D.DrawHandler(viewer,SuperMap3D.DrawMode.Polygon,i);break;case"Marker":window.handlerMarker=new SuperMap3D.DrawHandler(viewer,SuperMap3D.DrawMode.Marker,i);break;case"Box":window.handlerBox=new SuperMap3D.DrawHandler(viewer,SuperMap3D.DrawMode.Box,i)}window.tooltip||(window.tooltip=function(e){var t=function(e){var t=document.createElement("DIV");t.className="twipsy right";var i=document.createElement("DIV");i.className="twipsy-arrow",t.appendChild(i);var n=document.createElement("DIV");n.className="twipsy-inner",t.appendChild(n),this._div=t,this._title=n,this.message="",e.appendChild(t);var o=this;t.onmousemove=function(e){o.showAt({x:e.clientX,y:e.clientY},o.message)}};return t.prototype.setVisible=function(e){this._div.style.display=e?"block":"none"},t.prototype.showAt=function(e,t){e&&t&&(this.setVisible(!0),this._title.innerHTML=t,this._div.style.left=e.x+10+"px",this._div.style.top=e.y-this._div.clientHeight/2+"px",this.message=t)},new t(e)}(viewer._element)),window.polylineCollection||(window.polylineCollection=new SuperMap3D.PolylineCollection({translucentRS:SuperMap3D.RenderState.fromCache({depthMask:!1,depthTest:{enabled:!1}})}),window.polylineTransparent=window.polylineCollection.add({width:2,material:SuperMap3D.Material.fromType(SuperMap3D.Material.ColorType,{color:SuperMap3D.Color.fromCssColorString("#51ff00").withAlpha(.3)})}),viewer.scene.primitives.add(window.polylineCollection))},k=function(e){var t;switch(e){case"Point":t=window.handlerPoint;break;case"Polyline":t=window.handlerPolyline;break;case"Polygon":t=window.handlerPolygon;break;case"Marker":t=window.handlerMarker;break;case"Box":t=window.handlerBox}return t};function _(e){var t=function(e){var t=document.createElement("DIV");t.className="tooltip",this._div=t,this.message="",e.appendChild(t)};return t.prototype.setVisible=function(e){this._div.style.right=e?"10px":"-300px"},t.prototype.showAt=function(e,t){t&&(this._div.style.top=t),e&&(this.setVisible(!0),this._div.innerHTML=e)},new t(e)}function T(a){var l,s,c,u=e({viewlongitude:"",viewlatitude:"",viewheight:"",direction:"",pitch:"",horizontal:20,vertical:10,distance:200,hintLineColor:"rgba(251,250,248,1)",clipMode:"clip-inside",visibleLine:!0,fileText:"",fromInfo:null});if(a)for(var d in a)u.hasOwnProperty(d)?u[d]=a[d]:x.errorMsg(O.AttributeError+d);var p,v,w,f=i(null),m=new Map,h="public/data/s3m/projector.s3m",y=!1,g=null,P=new FileReader,D=!1;function L(e,t){return new Promise((function(i,n){var o=document.getElementById("videoContain"),r=document.createElement("video"),a=document.createElement("source");a.src=e,r.appendChild(a),r.id="trailer-"+t,r.classList.add("videoBox"),r.setAttribute("autoplay","autoplay"),r.setAttribute("loop","loop"),r.setAttribute("crossorigin","crossorigin"),r.setAttribute("controls","controls"),r.setAttribute("muted","muted"),o.appendChild(r),setTimeout((function(){i(r)}),500)}))}function E(e){if(!D){if(y){viewer.enableCursorStyle=!0,document.body.classList.remove("measureCur");var t=SuperMap3D.Cartesian3.fromDegrees(c.viewPosition[0],c.viewPosition[1],c.viewPosition[2]),i=JSON.parse(JSON.stringify(t));return viewer.eventManager.removeEventListener("MOUSE_MOVE",I),n=i,o="projector-"+(new Date).getTime(),r=c.direction,a=c.pitch,l=SuperMap3D.Math.toRadians(r),s=l>=SuperMap3D.Math.PI?l-SuperMap3D.Math.PI:l+SuperMap3D.Math.PI,d=-SuperMap3D.Math.toRadians(a),p.add(h,{id:o,position:n,hpr:{heading:s,pitch:0,roll:d}}),g=p.getInstance(h,o),m.set(o,c),void(y=!1)}var n,o,r,a,l,s,d,w=viewer.scene.pick(e.message.position)||viewer.selectedEntity;if(w&&w.id&&"string"==typeof w.id&&-1!=w.id.indexOf("projector-"))return v&&v.destroy(),g=w,void((c=m.get(w.id))&&(u.horizontal=c.horizontalFov,u.vertical=c.verticalFov,u.distance=c.distance));g=null,c=null}}function I(e){var t=0,i=viewer.scene.camera.position,n=s.pickPosition(e.message.endPosition);n&&(t=SuperMap3D.Cartesian3.distance(i,n)),t>0&&t<1e3&&c.setDistDirByPoint(j(n))}return C.isViewer&&(window.tooltip||(window.tooltip=_(viewer._element)),s=viewer.scene,l=viewer.scene.layers.layerQueue,p=new SuperMap3D.S3MInstanceCollection(s._context),viewer.scene.primitives.add(p),viewer.eventManager.addEventListener("CLICK",E,!0)),n((function(){return C.isViewer}),(function(e){e&&(window.tooltip||(window.tooltip=_(viewer._element)),s=viewer.scene,l=viewer.scene.layers.layerQueue,p=new SuperMap3D.S3MInstanceCollection(s._context),viewer.scene.primitives.add(p))})),n((function(){return C.changeLayers}),(function(e){for(var t=0;t<l.length;t++)l[t].selectEnabled=!1})),o((function(){f.value.addEventListener("change",(function(e){var t=e.target.files[0];if(t){u.fileText=f.value.value;var i=new Blob([t],{type:"video/mp4"});P.readAsDataURL(i),P.onload=function(e){var t=e.target.result,i=document.querySelectorAll("#videoContain>video").length;L(t,i).then((function(e){w=document.getElementById("trailer-"+i)}))}}})),w=document.getElementById("trailer-0")})),n((function(){return u.fileText}),(function(e){if(-1!==e.indexOf("http")){var t=document.querySelectorAll("#videoContain>video").length;L(e,t).then((function(e){w=document.getElementById("trailer-"+t)}))}})),n((function(){return u.horizontal}),(function(e){""!=e&&c&&(c.horizontalFov=Number(e))})),n((function(){return u.vertical}),(function(e){""!=e&&c&&(c.verticalFov=Number(e))})),n((function(){return u.distance}),(function(e){""!=e&&c&&(c.distance=Number(e))})),n((function(){return u.visibleLine}),(function(e){c&&(p.visible=e,m.forEach((function(t){t.hintLineVisible=e})))})),n((function(){return u.hintLineColor}),(function(e){c&&(c.hintLineColor=SuperMap3D.Color.fromCssColorString(e))})),n((function(){return u.clipMode}),(function(e){if(c){var t="clip-outside"===e?SuperMap3D.ModifyRegionMode.CLIP_INSIDE:SuperMap3D.ModifyRegionMode.CLIP_OUTSIDE;c.setClipMode(t)}})),n((function(){return u.viewlongitude}),(function(e){c&&""!=e&&(c.viewPosition[0]=e)})),n((function(){return u.viewlatitude}),(function(e){c&&""!=e&&(c.viewPosition[1]=e)})),n((function(){return u.viewheight}),(function(e){c&&""!=e&&(c.viewPosition[2]=e)})),n((function(){return u.direction}),(function(e){c&&""!=e&&(c.direction=Number(e))})),n((function(){return u.pitch}),(function(e){c&&""!=e&&(c.pitch=Number(e))})),n((function(){return u.fromInfo}),(function(e){e&&""!=e&&SuperMap3D.ProjectionImage.fromInfo(s,u.fromInfo.infoUrl,u.fromInfo.baseUrl)})),r((function(){for(var e=0;e<l.length;e++)l[e].selectEnabled=!0})),b(b({},t(u)),{},{chooseFile:function(){f.value.click()},vedioFile_dom:f,startProjection:function(){viewer.enableCursorStyle=!1,viewer._element.style.cursor="",document.body.classList.add("measureCur");var e=viewer.scene.camera.position;w.play(),(c=new SuperMap3D.ProjectionImage(s)).setImage({video:w}),c.distance=Number(u.distance),c.horizontalFov=Number(u.horizontal),c.verticalFov=Number(u.vertical),c.viewPosition=j(e),c.build(),y=!0,window.tooltip.showAt(" <p>选中投放模型进行编辑和清除</p>","400px"),viewer.eventManager.addEventListener("MOUSE_MOVE",I),viewer.eventManager.addEventListener("CLICK",E,!0)},clear:function(){var e,t;viewer.eventManager.removeEventListener("MOUSE_MOVE",I),g&&(m.delete(g.id),p.removeInstance(h,g.id),g=null),c&&(c.removeAllClipRegion(),c.destroy()),0===m.size&&viewer.eventManager.removeEventListener("CLICK",E),v&&v.destroy(),v=null,c=null,window.tooltip.setVisible(!1),(t=e?k(e):window.handlerPolygon)&&(t.deactivate(),t.clear(),viewer.enableCursorStyle=!0,window.tooltip.setVisible(!1),window.polylineTransparent&&(window.polylineTransparent.show=!1)),viewer.enableCursorStyle=!0,document.body.classList.remove("measureCur")},clipProjectImg:function(){D=!0,tooltip.setVisible(!1),window.tooltip.showAt(" <p>点击鼠标左键绘制裁剪区域</p><p>点击鼠标右键结束绘制</p><p>注：只能裁剪当前选中投放对象</p>","400px"),window.handlerPolygon||V("Polygon"),function(e,t,i){var n=!0;!1===t&&(n=t);var o=k(e);return new Promise((function(t,i){var r=window.tooltip,a=o.activeEvt.addEventListener((function(t){1==t?(viewer.enableCursorStyle=!1,viewer._element.style.cursor="","Point"==e||"Marker"==e?document.body.classList.add("measureCur"):document.body.classList.add("drawCur")):(viewer.enableCursorStyle=!0,r.setVisible(!1),"Point"==e||"Marker"==e?document.body.classList.remove("measureCur"):document.body.classList.remove("drawCur"))})),l=o.movingEvt.addEventListener((function(t){if(t.x<200&&t.y<150)r.setVisible(!1);else if(o.polyline&&o.isDrawing){var i=M(o.positions);"Polygon"==e&&i.push(i[0]),window.polylineTransparent.show=!0,window.polylineTransparent.positions=i}})),s=o.drawEvt.addEventListener((function(i){if(!i.object.positions&&"Point"!=e&&"Box"!=e)return r.showAt(i,"<p>请绘制正确的多边形</p>"),o.polygon.show=!1,o.polyline.show=!1,o.deactivate(),void o.activate();if("Box"!=e){if("Point"==e||"Marker"==e)o.clear(),t({result:i});else{if(window.polylineTransparent.show=n,n&&"Polygon"==e&&n){o.polygon._polygon._material._color._value.alpha=.1;var c=M(i.object.positions);c.push(c[0]),window.polylineTransparent.positions=c}var u=S(i.object.positions);t({result:i,positions:u})}a(),l(),s()}else t({result:i})}))}))}("Polygon").then((function(e){D=!1;var t=window.handlerPolygon;!function(e){if(!c)return;c.addClipRegion({name:"clip-Projector"+(new Date).getTime(),position:e})}(e.positions),t.polygon.show=!1,t.polyline.show=!1,window.polylineTransparent.show=!1,t.deactivate()}),(function(e){console.log(e)})),window.handlerPolygon.activate()}})}var A={name:"Sm3dProjectionImage",props:{fileText:{type:Number},fromInfo:{type:Object}},setup:function(e){var t=T(e);return{horizontal:t.horizontal,vertical:t.vertical,distance:t.distance,clipMode:t.clipMode,visibleLine:t.visibleLine,fileText:t.fileText,chooseFile:t.chooseFile,vedioFile_dom:t.vedioFile_dom,startProjection:t.startProjection,clear:t.clear,clipProjectImg:t.clipProjectImg}}},R={id:"fly-route-panel",class:"sm-panel"},B={class:"sm-function-module-sub-section",style:{margin:"0"}},F={class:"sm-half-L"},N={style:{width:"30%"}},z={type:"file",accept:"*.mp4",id:"vedioFile",style:{display:"none"},ref:"vedioFile_dom"},U={class:"sm-half-L"},H={style:{width:"30%"}},W={class:"sm-half-L"},q={style:{width:"30%"}},K={class:"sm-half-L"},J={style:{width:"30%"}},Q={class:"sm-half-L"},G={style:{width:"30%"}},X={class:"sm-half",style:{width:"68%"}},Y={style:{width:"auto"}},$={style:{width:"auto"}},Z={class:"sm-half-L flex-between"},ee={style:{width:"auto"}},te={class:"boxchild",style:{padding:"0"}},ie=d("div",{id:"videoContain",style:{width:"0",height:"0"}},[d("video",{id:"trailer-0",style:{visibility:"hidden"},autoplay:"",loop:"",crossorigin:"",controls:"",muted:"",multiple:""},[d("source",{src:"public/data/media/video.mp4",type:"video/mp4"})])],-1);A.render=function(e,t,i,n,o,r){var y=a("el-slider"),g=l("stopdrag"),b=l("drag");return s((c(),u("div",R,[s(d("div",B,[d("div",F,[d("label",N,p(e.Resource.videoUrl),1),s(d("input",{type:"text",class:"sm-input",style:{width:"65%",position:"relative","padding-right":"30px"},"onUpdate:modelValue":t[1]||(t[1]=function(e){return n.fileText=e}),placeholder:e.Resource.fileType},null,8,["placeholder"]),[[v,n.fileText]]),d("span",{class:"iconfont iconwenjianjia fpfFile",onClick:t[2]||(t[2]=function(){return n.chooseFile&&n.chooseFile.apply(n,arguments)})}),d("input",z,null,512)]),d("div",U,[d("label",H,p(e.Resource.horizontal),1),d(y,{modelValue:n.horizontal,"onUpdate:modelValue":t[3]||(t[3]=function(e){return n.horizontal=e}),min:.5,max:60,step:.5,"input-size":"mini",debounce:500,"tooltip-class":"tooltip-class",style:{width:"65%"}},null,8,["modelValue","min","step"])]),d("div",W,[d("label",q,p(e.Resource.vertical),1),d(y,{modelValue:n.vertical,"onUpdate:modelValue":t[4]||(t[4]=function(e){return n.vertical=e}),min:.5,max:60,step:.5,"input-size":"mini",debounce:500,"tooltip-class":"tooltip-class",style:{width:"65%"}},null,8,["modelValue","min","step"])]),d("div",K,[d("label",J,p(e.Resource.projectDistance),1),d(y,{modelValue:n.distance,"onUpdate:modelValue":t[5]||(t[5]=function(e){return n.distance=e}),min:1,max:500,"input-size":"mini",debounce:500,"tooltip-class":"tooltip-class",style:{width:"65%"}},null,8,["modelValue"])]),d("div",Q,[d("label",G,p(e.Resource.clipMode),1),d("div",X,[d("label",Y,[s(d("input",{type:"radio",value:"clip-inside","onUpdate:modelValue":t[6]||(t[6]=function(e){return n.clipMode=e})},null,512),[[w,n.clipMode]]),f(" "+p(e.Resource.clipInside),1)]),d("label",$,[s(d("input",{type:"radio",value:"clip-outside","onUpdate:modelValue":t[7]||(t[7]=function(e){return n.clipMode=e})},null,512),[[w,n.clipMode]]),f(" "+p(e.Resource.clipOutside),1)])])]),d("div",Z,[d("label",ee,[s(d("input",{type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=function(e){return n.visibleLine=e})},null,512),[[m,n.visibleLine]]),f(" "+p(e.Resource.visibleLine),1)]),h(' <label style="width:auto">\r\n          <input type="checkbox" v-model="visibleLine" />显示投放线\r\n        </label>')]),d("div",te,[d("button",{class:"tbtn",type:"button",onClick:t[9]||(t[9]=function(){return n.startProjection&&n.startProjection.apply(n,arguments)})},p(e.Resource.projection),1),d("button",{class:"tbtn tbtn-margin-left",type:"button",onClick:t[10]||(t[10]=function(){return n.clipProjectImg&&n.clipProjectImg.apply(n,arguments)})},p(e.Resource.clip),1),d("button",{class:"tbtn tbtn-margin-left",type:"button ",onClick:t[11]||(t[11]=function(){return n.clear&&n.clear.apply(n,arguments)})},p(e.Resource.clear),1)]),ie],512),[[g]])],512)),[[b]])},A.__file="src/components/scene/projection-image/projection-image.vue",A.install=function(e){e.component(A.name,A)};export default A;
