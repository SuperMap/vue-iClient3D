define(["./when-b60132fc","./buildModuleUrl-c0836874","./EllipsoidRhumbLine-18dee174","./arrayFill-1179ff06","./BoundingRectangle-d0552dc9","./Cartesian2-c4c2a8f9","./Cartesian4-442405e6","./Cartographic-2cfa3a3a","./Math-3024ab74","./FeatureDetection-caf5f946","./EllipsoidGeodesic-97d03085","./EllipsoidTangentPlane-1a9db025","./GeometryAttribute-eb047ff3","./PolygonGeometryLibrary-ceffc78b","./GeometryOffsetAttribute-fbeb6f1a","./GeometryPipeline-7ee31a30","./IndexDatatype-a3f4b187","./Transforms-04c4d562","./VertexFormat-ae18728e","./WebGLConstants-aba9fc67","./Plane-6b2f5e52","./PrimitiveType-ebb8c588","./GeometryAttributes-252e9929","./earcut-2.2.1-20c8012f","./AttributeCompression-2ece5912","./EncodedCartesian3-6a9cfb29"],(function(e,t,r,a,o,i,n,s,l,u,c,p,y,g,m,d,h,f,b,v,_,P,x,w,C,T){"use strict";var A=new s.Cartographic,E=new s.Cartographic;function I(e,t,r,a){var o=a.cartesianToCartographic(e,A).height,i=a.cartesianToCartographic(t,E);i.height=o,a.cartographicToCartesian(i,t);var n=a.cartesianToCartographic(r,E);n.height=o-100,a.cartographicToCartesian(n,r)}var G=new o.BoundingRectangle,V=new n.Cartesian3,F=new n.Cartesian3,N=new n.Cartesian3,H=new n.Cartesian3,O=new n.Cartesian3,R=new n.Cartesian3,L=new n.Cartesian3,D=new n.Cartesian3,M=new n.Cartesian3,S=new i.Cartesian2,B=new i.Cartesian2,k=new n.Cartesian3,z=new f.Quaternion,Y=new i.Matrix3,U=new i.Matrix3;function W(t){var r=t.vertexFormat,o=t.geometry,s=t.shadowVolume,c=o.attributes.position.values,p=c.length,g=t.wall,d=t.top||g,h=t.bottom||g;if(r.st||r.normal||r.tangent||r.bitangent||s){var b=t.boundingRectangle,v=t.tangentPlane,_=t.ellipsoid,P=t.stRotation,x=t.perPositionHeight,w=S;w.x=b.x,w.y=b.y;var C,T=r.st?new Float32Array(p/3*2):void 0;r.normal&&(C=x&&d&&!g?o.attributes.normal.values:new Float32Array(p));var A=r.tangent?new Float32Array(p):void 0,E=r.bitangent?new Float32Array(p):void 0,G=s?new Float32Array(p):void 0,W=0,j=0,Q=F,q=N,K=H,Z=!0,J=Y,X=U;if(0!==P){var $=f.Quaternion.fromAxisAngle(v._plane.normal,P,z);J=i.Matrix3.fromQuaternion($,J),$=f.Quaternion.fromAxisAngle(v._plane.normal,-P,z),X=i.Matrix3.fromQuaternion($,X)}else J=i.Matrix3.clone(i.Matrix3.IDENTITY,J),X=i.Matrix3.clone(i.Matrix3.IDENTITY,X);var ee=0,te=0;d&&h&&(ee=p/2,te=p/3,p/=2);for(var re=0;re<p;re+=3){var ae=n.Cartesian3.fromArray(c,re,k);if(r.st){var oe=i.Matrix3.multiplyByVector(J,ae,V);oe=_.scaleToGeodeticSurface(oe,oe);var ie=v.projectPointOntoPlane(oe,B);i.Cartesian2.subtract(ie,w,ie);var ne=l.CesiumMath.clamp(ie.x/b.width,0,1),se=l.CesiumMath.clamp(ie.y/b.height,0,1);h&&(T[W+te]=ne,T[W+1+te]=se),d&&(T[W]=ne,T[W+1]=se),W+=2}if(r.normal||r.tangent||r.bitangent||s){var le=j+1,ue=j+2;if(g){if(re+3<p){var ce=n.Cartesian3.fromArray(c,re+3,O);if(Z){var pe=n.Cartesian3.fromArray(c,re+p,R);x&&I(ae,ce,pe,_),n.Cartesian3.subtract(ce,ae,ce),n.Cartesian3.subtract(pe,ae,pe),Q=n.Cartesian3.normalize(n.Cartesian3.cross(pe,ce,Q),Q),Z=!1}n.Cartesian3.equalsEpsilon(ce,ae,l.CesiumMath.EPSILON10)&&(Z=!0)}(r.tangent||r.bitangent)&&(K=_.geodeticSurfaceNormal(ae,K),r.tangent&&(q=n.Cartesian3.normalize(n.Cartesian3.cross(K,Q,q),q)))}else Q=_.geodeticSurfaceNormal(ae,Q),(r.tangent||r.bitangent)&&(x&&(L=n.Cartesian3.fromArray(C,j,L),D=n.Cartesian3.cross(n.Cartesian3.UNIT_Z,L,D),D=n.Cartesian3.normalize(i.Matrix3.multiplyByVector(X,D,D),D),r.bitangent&&(M=n.Cartesian3.normalize(n.Cartesian3.cross(L,D,M),M))),q=n.Cartesian3.cross(n.Cartesian3.UNIT_Z,Q,q),q=n.Cartesian3.normalize(i.Matrix3.multiplyByVector(X,q,q),q),r.bitangent&&(K=n.Cartesian3.normalize(n.Cartesian3.cross(Q,q,K),K)));r.normal&&(t.wall?(C[j+ee]=Q.x,C[le+ee]=Q.y,C[ue+ee]=Q.z):h&&(C[j+ee]=-Q.x,C[le+ee]=-Q.y,C[ue+ee]=-Q.z),(d&&!x||g)&&(C[j]=Q.x,C[le]=Q.y,C[ue]=Q.z)),s&&(g&&(Q=_.geodeticSurfaceNormal(ae,Q)),G[j+ee]=-Q.x,G[le+ee]=-Q.y,G[ue+ee]=-Q.z),r.tangent&&(t.wall?(A[j+ee]=q.x,A[le+ee]=q.y,A[ue+ee]=q.z):h&&(A[j+ee]=-q.x,A[le+ee]=-q.y,A[ue+ee]=-q.z),d&&(x?(A[j]=D.x,A[le]=D.y,A[ue]=D.z):(A[j]=q.x,A[le]=q.y,A[ue]=q.z))),r.bitangent&&(h&&(E[j+ee]=K.x,E[le+ee]=K.y,E[ue+ee]=K.z),d&&(x?(E[j]=M.x,E[le]=M.y,E[ue]=M.z):(E[j]=K.x,E[le]=K.y,E[ue]=K.z))),j+=3}}r.st&&(o.attributes.st=new y.GeometryAttribute({componentDatatype:u.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:T})),r.normal&&(o.attributes.normal=new y.GeometryAttribute({componentDatatype:u.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:C})),r.tangent&&(o.attributes.tangent=new y.GeometryAttribute({componentDatatype:u.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:A})),r.bitangent&&(o.attributes.bitangent=new y.GeometryAttribute({componentDatatype:u.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:E})),s&&(o.attributes.extrudeDirection=new y.GeometryAttribute({componentDatatype:u.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:G}))}if(t.extrude&&e.defined(t.offsetAttribute)){var ye=c.length/3,ge=new Uint8Array(ye);if(t.offsetAttribute===m.GeometryOffsetAttribute.TOP)d&&h||g?ge=a.arrayFill(ge,1,0,ye/2):d&&(ge=a.arrayFill(ge,1));else{var me=t.offsetAttribute===m.GeometryOffsetAttribute.NONE?0:1;ge=a.arrayFill(ge,me)}o.attributes.applyOffset=new y.GeometryAttribute({componentDatatype:u.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:ge})}return o}var j=new s.Cartographic,Q=new s.Cartographic,q={west:0,east:0},K=new c.EllipsoidGeodesic;function Z(a,o,i,n,s){if(s=e.defaultValue(s,new t.Rectangle),!e.defined(a)||a.length<3)return s.west=0,s.north=0,s.south=0,s.east=0,s;if(i===r.ArcType.RHUMB)return t.Rectangle.fromCartesianArray(a,o,s);K.ellipsoid.equals(o)||(K=new c.EllipsoidGeodesic(void 0,void 0,o)),s.west=Number.POSITIVE_INFINITY,s.east=Number.NEGATIVE_INFINITY,s.south=Number.POSITIVE_INFINITY,s.north=Number.NEGATIVE_INFINITY,q.west=Number.POSITIVE_INFINITY,q.east=Number.NEGATIVE_INFINITY;for(var u,p=1/l.CesiumMath.chordLength(n,o.maximumRadius),y=a.length,g=o.cartesianToCartographic(a[0],Q),m=j,d=1;d<y;d++)u=m,m=g,g=o.cartesianToCartographic(a[d],u),K.setEndPoints(m,g),X(K,p,s,q);return u=m,m=g,g=o.cartesianToCartographic(a[0],u),K.setEndPoints(m,g),X(K,p,s,q),s.east-s.west>q.west-q.east&&(s.east=q.east,s.west=q.west),s}var J=new s.Cartographic;function X(e,t,r,a){for(var o=e.surfaceDistance,i=Math.ceil(o*t),n=i>0?o/(i-1):Number.POSITIVE_INFINITY,s=0,l=0;l<i;l++){var u=e.interpolateUsingSurfaceDistance(s,J);s+=n;var c=u.longitude,p=u.latitude;r.west=Math.min(r.west,c),r.east=Math.max(r.east,c),r.south=Math.min(r.south,p),r.north=Math.max(r.north,p),a.west=c>0?Math.min(c,a.west):a.west,a.east=c<0?Math.max(c,a.east):a.east}}var $=[];function ee(e,t,r,a,o,i,n,s,l,u){var c,y={walls:[]};if(i||n){var m,d,f=g.PolygonGeometryLibrary.createGeometryFromPositions(e,t,r,o,s,l),b=f.attributes.position.values,v=f.indices;if(i&&n){var _=b.concat(b);m=_.length/3,(d=h.IndexDatatype.createTypedArray(m,2*v.length)).set(v);var P=v.length,x=m/2;for(c=0;c<P;c+=3){var w=d[c]+x,C=d[c+1]+x,T=d[c+2]+x;d[c+P]=T,d[c+1+P]=C,d[c+2+P]=w}if(f.attributes.position.values=_,o&&s.normal){var A=f.attributes.normal.values;f.attributes.normal.values=new Float32Array(_.length),f.attributes.normal.values.set(A)}f.indices=d}else if(n){for(m=b.length/3,d=h.IndexDatatype.createTypedArray(m,v.length),c=0;c<v.length;c+=3)d[c]=v[c+2],d[c+1]=v[c+1],d[c+2]=v[c];f.indices=d}y.topAndBottom=new g.GeometryInstance({geometry:f})}var E,I=a.outerRing,G=p.EllipsoidTangentPlane.fromPoints(I,e),V=G.projectPointsOntoPlane(I,$),F=g.PolygonPipeline.computeWindingOrder2D(V);F===g.WindingOrder.CLOCKWISE&&(I=I.slice().reverse()),u&&(E=g.PolygonGeometryLibrary.computeWallGeometry(I,e,r,o,l),y.walls.push(new g.GeometryInstance({geometry:E})));var N=a.holes;for(c=0;c<N.length;c++){var H=N[c];V=(G=p.EllipsoidTangentPlane.fromPoints(H,e)).projectPointsOntoPlane(H,$),(F=g.PolygonPipeline.computeWindingOrder2D(V))===g.WindingOrder.COUNTER_CLOCKWISE&&(H=H.slice().reverse()),E=g.PolygonGeometryLibrary.computeWallGeometry(H,e,r,o,l),y.walls.push(new g.GeometryInstance({geometry:E}))}return y}function te(a){var o=a.polygonHierarchy,i=e.defaultValue(a.vertexFormat,b.VertexFormat.DEFAULT),n=e.defaultValue(a.ellipsoid,t.Ellipsoid.WGS84),s=e.defaultValue(a.granularity,l.CesiumMath.RADIANS_PER_DEGREE),u=e.defaultValue(a.stRotation,0),c=e.defaultValue(a.perPositionHeight,!1),p=c&&e.defined(a.extrudedHeight),y=e.defaultValue(a.height,0),m=e.defaultValue(a.extrudedHeight,y);if(!p){var d=Math.max(y,m);m=Math.min(y,m),y=d}this._vertexFormat=b.VertexFormat.clone(i),this._ellipsoid=t.Ellipsoid.clone(n),this._granularity=s,this._stRotation=u,this._height=y,this._extrudedHeight=m,this._closeTop=e.defaultValue(a.closeTop,!0),this._closeBottom=e.defaultValue(a.closeBottom,!0),this._extrudeOutering=e.defaultValue(a.extrudeOutering,!0),this._polygonHierarchy=o,this._perPositionHeight=c,this._perPositionHeightExtrude=p,this._shadowVolume=e.defaultValue(a.shadowVolume,!1),this._workerName="createPolygonGeometry",this._offsetAttribute=a.offsetAttribute,this._arcType=e.defaultValue(a.arcType,r.ArcType.GEODESIC),this._rectangle=void 0,this._textureCoordinateRotationPoints=void 0,this.packedLength=g.PolygonGeometryLibrary.computeHierarchyPackedLength(o)+t.Ellipsoid.packedLength+b.VertexFormat.packedLength+12}te.fromPositions=function(t){return new te({polygonHierarchy:{positions:(t=e.defaultValue(t,e.defaultValue.EMPTY_OBJECT)).positions},height:t.height,extrudedHeight:t.extrudedHeight,vertexFormat:t.vertexFormat,stRotation:t.stRotation,ellipsoid:t.ellipsoid,granularity:t.granularity,perPositionHeight:t.perPositionHeight,closeTop:t.closeTop,closeBottom:t.closeBottom,offsetAttribute:t.offsetAttribute,arcType:t.arcType})},te.pack=function(r,a,o){return o=e.defaultValue(o,0),o=g.PolygonGeometryLibrary.packPolygonHierarchy(r._polygonHierarchy,a,o),t.Ellipsoid.pack(r._ellipsoid,a,o),o+=t.Ellipsoid.packedLength,b.VertexFormat.pack(r._vertexFormat,a,o),o+=b.VertexFormat.packedLength,a[o++]=r._height,a[o++]=r._extrudedHeight,a[o++]=r._granularity,a[o++]=r._stRotation,a[o++]=r._perPositionHeightExtrude?1:0,a[o++]=r._perPositionHeight?1:0,a[o++]=r._closeTop?1:0,a[o++]=r._closeBottom?1:0,a[o++]=r._shadowVolume?1:0,a[o++]=e.defaultValue(r._offsetAttribute,-1),a[o++]=r._arcType,a[o]=r.packedLength,a};var re=t.Ellipsoid.clone(t.Ellipsoid.UNIT_SPHERE),ae=new b.VertexFormat,oe={polygonHierarchy:{}};return te.unpack=function(r,a,o){a=e.defaultValue(a,0);var i=g.PolygonGeometryLibrary.unpackPolygonHierarchy(r,a);a=i.startingIndex,delete i.startingIndex;var n=t.Ellipsoid.unpack(r,a,re);a+=t.Ellipsoid.packedLength;var s=b.VertexFormat.unpack(r,a,ae);a+=b.VertexFormat.packedLength;var l=r[a++],u=r[a++],c=r[a++],p=r[a++],y=1===r[a++],m=1===r[a++],d=1===r[a++],h=1===r[a++],f=1===r[a++],v=r[a++],_=r[a++],P=r[a];return e.defined(o)||(o=new te(oe)),o._polygonHierarchy=i,o._ellipsoid=t.Ellipsoid.clone(n,o._ellipsoid),o._vertexFormat=b.VertexFormat.clone(s,o._vertexFormat),o._height=l,o._extrudedHeight=u,o._granularity=c,o._stRotation=p,o._perPositionHeightExtrude=y,o._perPositionHeight=m,o._closeTop=d,o._closeBottom=h,o._shadowVolume=f,o._offsetAttribute=-1===v?void 0:v,o._arcType=_,o.packedLength=P,o},te.computeRectangle=function(a,o){var i=e.defaultValue(a.granularity,l.CesiumMath.RADIANS_PER_DEGREE),n=e.defaultValue(a.arcType,r.ArcType.GEODESIC),s=a.polygonHierarchy,u=e.defaultValue(a.ellipsoid,t.Ellipsoid.WGS84);return Z(s.positions,u,n,i,o)},te.createGeometry=function(r){var o=r._vertexFormat,i=r._ellipsoid,n=r._granularity,s=r._stRotation,c=r._polygonHierarchy,f=r._perPositionHeight,b=r._closeTop,v=r._closeBottom,_=r._arcType,P=c.positions;if(!(P.length<3)){var x=p.EllipsoidTangentPlane.fromPoints(P,i),w=g.PolygonGeometryLibrary.polygonsFromHierarchy(c,x.projectPointsOntoPlane.bind(x),!f,i),C=w.hierarchy,T=w.polygons;if(0!==C.length){P=C[0].outerRing;var A,E=g.PolygonGeometryLibrary.computeBoundingRectangle(x.plane.normal,x.projectPointOntoPlane.bind(x),P,s,G),I=[],V=r._height,F=r._extrudedHeight,N={perPositionHeight:f,vertexFormat:o,geometry:void 0,tangentPlane:x,boundingRectangle:E,ellipsoid:i,stRotation:s,bottom:!1,top:!0,wall:!1,extrude:!1,arcType:_};if(r._perPositionHeightExtrude||!l.CesiumMath.equalsEpsilon(V,F,0,l.CesiumMath.EPSILON2))for(N.extrude=!0,N.top=b,N.bottom=v,N.shadowVolume=r._shadowVolume,N.offsetAttribute=r._offsetAttribute,A=0;A<T.length;A++){var H,O=ee(i,T[A],n,C[A],f,b,v,o,_,r._extrudeOutering);b&&v?(H=O.topAndBottom,N.geometry=g.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(H.geometry,V,F,i,f)):b?((H=O.topAndBottom).geometry.attributes.position.values=g.PolygonPipeline.scaleToGeodeticHeight(H.geometry.attributes.position.values,V,i,!f),N.geometry=H.geometry):v&&((H=O.topAndBottom).geometry.attributes.position.values=g.PolygonPipeline.scaleToGeodeticHeight(H.geometry.attributes.position.values,F,i,!0),N.geometry=H.geometry),(b||v)&&(N.wall=!1,H.geometry=W(N),I.push(H));var R=O.walls;N.wall=!0;for(var L=0;L<R.length;L++){var D=R[L];N.geometry=g.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(D.geometry,V,F,i,f),D.geometry=W(N),I.push(D)}}else for(A=0;A<T.length;A++){var M=new g.GeometryInstance({geometry:g.PolygonGeometryLibrary.createGeometryFromPositions(i,T[A],n,f,o,_)});if(M.geometry.attributes.position.values=g.PolygonPipeline.scaleToGeodeticHeight(M.geometry.attributes.position.values,V,i,!f),N.geometry=M.geometry,M.geometry=W(N),e.defined(r._offsetAttribute)){var S=M.geometry.attributes.position.values.length,B=new Uint8Array(S/3),k=r._offsetAttribute===m.GeometryOffsetAttribute.NONE?0:1;a.arrayFill(B,k),M.geometry.attributes.applyOffset=new y.GeometryAttribute({componentDatatype:u.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:B})}I.push(M)}var z=d.GeometryPipeline.combineInstances(I)[0];z.attributes.position.values=new Float64Array(z.attributes.position.values),z.indices=h.IndexDatatype.createTypedArray(z.attributes.position.values.length/3,z.indices);var Y=z.attributes,U=t.BoundingSphere.fromVertices(Y.position.values);return o.position||delete Y.position,new y.Geometry({attributes:Y,indices:z.indices,primitiveType:z.primitiveType,boundingSphere:U,offsetAttribute:r._offsetAttribute})}}},te.createShadowVolume=function(e,t,r){var a=e._granularity,o=e._ellipsoid,i=t(a,o),n=r(a,o);return new te({polygonHierarchy:e._polygonHierarchy,ellipsoid:o,stRotation:e._stRotation,granularity:a,perPositionHeight:!1,extrudedHeight:i,height:n,vertexFormat:b.VertexFormat.POSITION_ONLY,shadowVolume:!0,arcType:e._arcType})},Object.defineProperties(te.prototype,{rectangle:{get:function(){if(!e.defined(this._rectangle)){var t=this._polygonHierarchy.positions;this._rectangle=Z(t,this._ellipsoid,this._arcType,this._granularity)}return this._rectangle}},textureCoordinateRotationPoints:{get:function(){return e.defined(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=function(e){var t=-e._stRotation;if(0===t)return[0,0,0,1,1,0];var r=e._ellipsoid,a=e._polygonHierarchy.positions,o=e.rectangle;return y.Geometry._textureCoordinateRotationPoints(a,t,r,o)}(this)),this._textureCoordinateRotationPoints}}}),function(r,a){return e.defined(a)&&(r=te.unpack(r,a)),r._ellipsoid=t.Ellipsoid.clone(r._ellipsoid),te.createGeometry(r)}}));
